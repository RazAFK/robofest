import cv2
import os
from datetime import datetime

def capture_image(camera_index=0, delay=2):
    """
    –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–∞–º–µ—Ä—ã
    
    Args:
        camera_index (int): –∏–Ω–¥–µ–∫—Å –∫–∞–º–µ—Ä—ã (0, 1, 2...)
        delay (int): –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å—ä–µ–º–∫–æ–π –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    """
    
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    if not os.path.exists('photos'):
        os.makedirs('photos')
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–∞–º–µ—Ä–µ
    cap = cv2.VideoCapture(camera_index)
    
    if not cap.isOpened():
        print(f"–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–∞–º–µ—Ä–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º {camera_index}")
        print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∏–Ω–¥–µ–∫—Å –∫–∞–º–µ—Ä—ã (0, 1, 2...)")
        return False
    
    # –î–∞–µ–º –∫–∞–º–µ—Ä–µ –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    print(f"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã... –ñ–¥–∏—Ç–µ {delay} —Å–µ–∫—É–Ω–¥")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    for i in range(delay * 10):
        ret, frame = cap.read()
        if ret:
            cv2.imshow('Camera Preview - –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è —Å—ä–µ–º–∫–∏', frame)
            if cv2.waitKey(1) & 0xFF != 255:
                break
    
    # –î–µ–ª–∞–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π —Å–Ω–∏–º–æ–∫
    ret, frame = cap.read()
    
    if ret:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"photos/photo_{timestamp}.jpg"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        cv2.imwrite(filename, frame)
        print(f"‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filename}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        cv2.imshow('Captured Image - –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞', frame)
        cv2.waitKey(0)
        cv2.destroyAllWindows()
        
    else:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
    
    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∫–∞–º–µ—Ä—É
    cap.release()
    return True

# –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
if __name__ == "__main__":
    # –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å –∫–∞–º–µ—Ä—ã (0 - –ø–µ—Ä–≤–∞—è, 1 - –≤—Ç–æ—Ä–∞—è –∏ —Ç.–¥.)
    camera_index = 0
    
    print("üì∑ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–∞–º–µ—Ä—ã")
    print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞ —Å –∏–Ω–¥–µ–∫—Å–æ–º: {camera_index}")
    
    success = capture_image(camera_index)
    
    if not success:
        # –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –∏–Ω–¥–µ–∫—Å—ã –∫–∞–º–µ—Ä
        for i in range(1, 5):
            print(f"–ü—Ä–æ–±—É–µ–º –∫–∞–º–µ—Ä—É —Å –∏–Ω–¥–µ–∫—Å–æ–º {i}...")
            if capture_image(i):
                break